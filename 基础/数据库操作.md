# 数据库操作

在Java安全代码审计中，数据库操作是另一个关键审计点。下面提供不同数据库操作方式的Demo。

## 基础JDBC操作

### 不安全的Statement

```java
import java.sql.*;

public class UnsafeJdbcDemo {
    public static void main(String[] args) {
        String url = "jdbc:mysql://localhost:3306/test";
        String username = "root";
        String password = "password";
        
        // 模拟用户输入
        String userInput = "admin' OR '1'='1";
        
        try (Connection conn = DriverManager.getConnection(url, username, password)) {
            // 不安全的Statement
            Statement stmt = conn.createStatement();
            
            // 存在SQL注入的查询
            String sql = "SELECT * FROM users WHERE username = '" + userInput + "'";
            System.out.println("执行的SQL: " + sql);
            
            ResultSet rs = stmt.executeQuery(sql);
            while (rs.next()) {
                System.out.println("查询到用户: " + rs.getString("username"));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
```

### 安全的PreparedStatement

```java
import java.sql.*;

public class SafeJdbcDemo {
    public static void main(String[] args) {
        String url = "jdbc:mysql://localhost:3306/test";
        String username = "root";
        String password = "password";
        
        // 模拟用户输入
        String userInput = "admin' OR '1'='1";
        
        try (Connection conn = DriverManager.getConnection(url, username, password)) {
            // 使用PreparedStatement防止SQL注入
            String sql = "SELECT * FROM users WHERE username = ?";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, userInput);
            
            System.out.println("执行的SQL: " + pstmt);
            
            ResultSet rs = pstmt.executeQuery();
            while (rs.next()) {
                System.out.println("查询到用户: " + rs.getString("username"));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
```

## MyBatis

### 不安全的${}

```xml
<!-- 不安全的MyBatis映射 -->
<select id="findUserByName" resultType="User">
    SELECT * FROM users WHERE username = '${username}'
</select>
```

### 安全的#{}

```xml
<!-- 安全的MyBatis映射 -->
<select id="findUserByName" resultType="User">
    SELECT * FROM users WHERE username = #{username}
</select>
```

### 动态SQL的安全使用

```xml
<!-- 安全的动态SQL -->
<select id="findUsers" resultType="User">
    SELECT * FROM users
    <where>
        <if test="username != null">
            AND username = #{username}
        </if>
        <if test="email != null">
            AND email = #{email}
        </if>
    </where>
    ORDER BY
    <choose>
        <when test="orderBy == 'name'">username</when>
        <when test="orderBy == 'email'">email</when>
        <otherwise>id</otherwise>
    </choose>
</select>
```

## JPA/Hibernate

### 不安全的拼接SQL

```java
// 不安全的HQL拼接
String userInput = "admin' OR '1'='1";
String hql = "FROM User WHERE username = '" + userInput + "'";
Query query = session.createQuery(hql);
List<User> users = query.list();
```

### 安全的参数绑定

```java
// 安全的HQL参数绑定
String hql = "FROM User WHERE username = :username";
Query query = session.createQuery(hql);
query.setParameter("username", userInput);
List<User> users = query.list();
```

### JPA Criteria API安全示例

```java
// 安全的Criteria API
CriteriaBuilder cb = entityManager.getCriteriaBuilder();
CriteriaQuery<User> query = cb.createQuery(User.class);
Root<User> root = query.from(User.class);

// 参数化查询
ParameterExpression<String> param = cb.parameter(String.class);
query.select(root).where(cb.equal(root.get("username"), param));

TypedQuery<User> typedQuery = entityManager.createQuery(query);
typedQuery.setParameter(param, userInput);
List<User> users = typedQuery.getResultList();
```

